---
lab:
  title: 使用 Azure Monitor 实现实时监控
  module: Observability and Continuous Improvement
---

# 实验室 02：使用 Azure Monitor 实现实时监控

## 预计用时：20 分钟

## 先决条件

- Azure 订阅 - 如果没有 Azure 订阅，请创建一个[免费帐户](https://azure.microsoft.com/free/)。
- 监控与可观测性概念的基础知识。
- 基本了解 Azure 服务。

## 目标

- 创建一个示例 Web 应用。
- 启用并配置 Azure Monitor 和 Application Insights。
- 创建自定义仪表板，以便可视化应用程序指标。
- 设置警报，提醒利益相关人性能异常。
- 分析性能数据，以寻找潜在的改进机会。

## 练习 1：创建一个示例 Web 应用程序

作为平台工程师，你需要确保平台上运行的应用程序具有可观察行，并能持续监控。 在本实验室中，你将创建一个示例 Web 应用程序到 Azure、配置 Azure Monitor 和 Application Insights，设置自定义仪表板，并创建警报来追踪应用程序性能。

### 任务 1：创建 Azure Web 应用

1. 打开 Azure 门户。
1. 在搜索栏中，键入“应用程序服务”，并选择它。
1. 单击“+ 创建”，然后选择“Web 应用”。
1. 在“基本信息”选项卡中：
   - 订阅：选择 Azure 订阅。
   - 资源组：单击“新建”，输入 **`monitoringlab-rg`**，然后单击“确定”。
   - 名称：输入唯一名称，例如 **`monitoringlab-webapp`**。
   - 发布：选择“代码”。
   - 运行时堆栈，选择 NET 8 (LTS)。
   - 区域：选择附近的区域。
1. 依次单击“查看 + 创建”和“创建”。
1. 等待部署完成，然后单击“转到资源”。
1. 在“概述”选项卡中，单击 URL 以验证 Web 应用是否正在运行。

### 任务 2：验证 Application Insights

1. 在 Web 应用资源中，滚动到“监视”部分。
1. 单击 “Application Insights”。
1. 已为此 Web 应用启用 Application Insights。 单击连接，打开 Application Insights 资源。
1. 在 Application Insights 资源中，单击应用程序仪表板，以查看提供的默认仪表板的性能数据。

## 练习 2：配置 Azure Monitor 和仪表板

### 任务 1：访问 Azure Monitor

1. 在 Azure 门户中，搜索监控并单击它。
1. 单击左侧面板中的指标
1. 在“范围”部分，选择在其中部署 Web 应用的订阅和资源组下的 Web 应用。
1. 单击“应用”并观察可用于 Web 应用的指标。

### 任务 2：向仪表板添加关键指标

1. 在“范围”部分中，选择 Web 应用（monitoringlab-webapp）。
1. 在“指标”下，选择“响应时间”。
1. 将聚合设置为“Average”，然后单击“+ 添加指标”。
1. 添加其他指标请重复此步骤。
   - CPU 时间（计数）
   - 请求（Average）
1. 单击仪表板并固定到仪表板。
1. 选择键入“共享”类型，然后选择订阅和 monitoringlab-webapp 仪表板。
1. 单击“固定到仪表板”。
1. 单击左侧面板中的仪表板图标以查看仪表板。
1. 验证指标是否显示在仪表板上，并实时更新。

## 练习 3：创建警报

### 任务 1：定义警报条件与操作

1. 在 Azure Monitor 中，单击“警报”。
1. 选择“创建 +”，然后选择“警报规则”。
1. 在“作用域”下，选择 Web 应用（monitoringlab-webapp），然后单击“应用”。
1. 在“条件”下，单击“信号名”字段，然后选择“响应时间”。
1. 配置警报规则：
   - 阈值类型：动态
   - 聚合类型：Average
   - 值：大于或小于
   - 阈值敏感度：高
   - 评估时间：每 1 分钟检查一次，并回溯最近 5 分钟的数据。
1. 在“操作”下，选择“使用快速操作”。
1. 输入：
   - 操作组名：WebAppMonitoringAlerts
   - 显示名：WebAlert
   - 电子邮件：输入你的电子邮件地址。
1. 单击“ 保存”。
1. 单击“下一步”：“详细信息”。
1. 输入名称 `WebAppResponseTimeAlert`，并选择严重性级别为“详细”。
1. 单击“查看 + 创建”，然后选择“创建”。

   > **注意：** 预警规则已创建，响应时间超过阈值时将触发电子邮件通知。 你可以通过向 Web 应用发送大量请求，强制触发警报。 例如，你可以使用 Azure 负载测试服务或 Apache JMeter 等工具。

1. 返回到 Azure Monitor > 警报。
1. 单击“警报规则”，即可看到你创建的警报规则。

## 练习 4：分析性能数据

### 任务 1：查看收集的指标

1. 转到“Azure 门户”中的“Application Insights” 。
1. 单击应用程序仪表板。
1. 单击“性能”磁贴，分析服务器的响应时间与负载情况。 你还可以查看请求数及失败请求数。
1. 单击“使用工作簿进行分析”，然后选择“性能计数器分析”。
1. 单击“工作簿”。
1. 选择“性能”下的工作簿性能分析。
1. 你可以看到 Web 应用的性能数据。

> **注意：** 你可以自定义工作簿，添加其他指标与筛选器。
